<!DOCTYPE html>
<html>
<head>
    <title>camara web</title>
</head>

<body>
    <div id="videos">
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <!--script src="https://webrtc.github.io/adapter/adapter-latest.js"></script-->
    <script src="assets/js/adapter-latest.js"></script>
    <script>
    'use strict';
    var localStream; //var global, se la puede consultar
    var socket = io();
    var quienesreciben = {};  //para cuando hay varios puestos de vigilancia
    var quiensoy;
    var ICE_SERVERS = [
        { url: 'stun:stun4.l.google.com:19302' }
    ];
    //,    {"urls":"turn:numb.viagenie.ca", "username":"webrtc@live.com", "credential":"muazkh"}            

    socket.on('welcome', function(data) {
        console.log(data.message);
        socket.emit('i am client', { app: 'webcam', id: data.id });
        quiensoy = data.id;
    });
    socket.on('seDesconecto', function(cual) {
        for (let id in quienesreciben) {
            if (id === cual) {
                //console.log('seDesconecto');
                quienesreciben[cual].close();
                quienesreciben[cual] = null;
                delete quienesreciben[cual];
            }
        }
    });
    socket.on('disconnect', function() {
        console.log("Aldaba se desconecto");
        for (let cual in quienesreciben) {
            quienesreciben[cual].close();
            quienesreciben[cual] = null;
            delete quienesreciben[cual];
        }
    });


    //// conexion
    socket.on('arrancarWebcam', function(quienPide, configCamara) {
        navigator.mediaDevices.getUserMedia(configCamara)
            .then(function(stream) {
                //console.log('Adding local stream.');
                localStream = stream;
                //console.log(localStream);
                //localVideo.srcObject = stream;
                if (quienesreciben[quienPide] == undefined) {
                    console.log('arrancarWebcam.   lo pide: ', quienPide);
                    try {
                        quienesreciben[quienPide] = new RTCPeerConnection({ "iceServers": ICE_SERVERS });
                        quienesreciben[quienPide].addStream(localStream);
                        //console.log('Sending offer to peer');
                        quienesreciben[quienPide].createOffer(function(sessionDescription) {
                            quienesreciben[quienPide].setLocalDescription(sessionDescription);
                            //console.log('setLocalAndSendMessage sending message', sessionDescription.type);
                            socket.emit('webcamOferta', quiensoy, quienPide, sessionDescription);
                        }, function(error) {
                            console.log('createOffer() error: ', error);
                        });
                    } catch (e) {
                        console.log('Failed to create PeerConnection, exception: ' + e.message);
                        alert('Cannot create RTCPeerConnection object.');
                        return;
                    }
                }
            })
            .catch(function(e) {
                alert('getUserMedia() error: ' + e.name);
            });
    });

    socket.on('vigilanciaAtiendeOferta', function(origen, message) {
        //console.log('vigilanciaAtiendeOferta:', message.type, 'origen: ', origen);
        if (message.type === 'answer') {
            quienesreciben[origen].setRemoteDescription(new RTCSessionDescription(message));
        }
        if (message.type === 'candidate') {
            var candidate = new RTCIceCandidate({
                sdpMLineIndex: message.label,
                candidate: message.candidate
            });
            quienesreciben[origen].addIceCandidate(candidate);
        }
    });
    socket.on('webcamCambiaResolucion', function(constraints) {
        const track = window.localStream.getVideoTracks()[0];
        track.applyConstraints(constraints)
            .catch(err => {
                errorMessage('error al cambiar la configuracion de video;', err.name, constraints);
            });
    });
    /////


    window.onbeforeunload = function() {
        socket.emit('meDesconecto', quiensoy, function() { socket.close(); })
    };
    </script>
</body>

</html>